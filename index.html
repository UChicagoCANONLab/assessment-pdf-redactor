<script src="http://cdnjs.cloudflare.com/ajax/libs/processing.js/1.4.1/processing-api.min.js"></script><html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.4.1/jspdf.debug.js" integrity="sha384-THVO/sM0mFD9h7dfSndI6TS0PgAGavwKvB5hAxRRvc0o9cPLohB0wb/PTA7LdUHs" crossorigin="anonymous"></script>

<!--
  Created using jsbin.com
  Source can be edited via http://jsbin.com/pdfjs-helloworld-v2/8598/edit
-->
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <link href="jscropper.css" rel="stylesheet">
</head>
<body>
  <div style="text-align:center;">
    <h1> pdf cropper </h1>
    <input id='pdf' type='file' class="btn"/>

    <form>
      <div class='text_box'>
        <label for="uname">Inches to be cropped: </label>
        <input type="text" id="inches_input" name="name" placeholder="0 - 11; Default is 1">
      </div>
    </form>

    <input type="button" class="btn" value="Crop" id = "redact_button"/>

    <p class="status" id="process_status"></p>
    <p class="wait_time" id="wait_time"></p>
  </div>

  <script type="text/javascript" src="pdf.js"></script>
  <script type="text/javascript">

    //
    // Disable workers to avoid yet another cross-origin issue (workers need the URL of
    // the script to be loaded, and dynamically loading a cross-origin script does
    // not work)
    //
    PDFJS.disableWorker = true;
    //
    // Asynchronous download PDF as an ArrayBuffer
    //
    var pdf = document.getElementById('pdf');
    var o_pdf = new jsPDF();
    var inches = 1;
    var save_name;
    var loading_percent = 0;
    var percent_increment = 0;
    var percent_obj = document.getElementById('wait_time');

    document.getElementById('redact_button').onclick = function() {
      loading_percent = 0;

      inches = document.getElementById('inches_input').value;
      if(Number(inches)) {
        inches = Number(inches);
      }
      else if(inches == "" || !inches) {
        inches = 1;
      }
      else {
        inches = NaN;
      }

      if(!pdf.files[0]) {
        fileError();
      }
      else if(['application/pdf'].indexOf(pdf.files[0].type) == -1) {
        console.log("what");
        pdfError();
      }
      else if(!inches) {
        numberError();
      }
      else if(inches < 0) {
        lowerBoundError();
      }
      else if(inches > 11) {
        upperBoundError();
      }
      else {
        if (file = pdf.files[0]) {
        document.getElementById("process_status").style.color = "black";
        document.getElementById('process_status').innerHTML = "Processing... For better performance, stay on this tab.";
        updatePercent(0);
        

        fileReader = new FileReader();

        fileReader.onload = function(ev) {
          save_name = "CROPPED_" + pdf.files[0].name;

            console.log(ev);
            PDFJS.getDocument(fileReader.result).then(function getPdfHelloWorld(pdf) {
              //
              // Fetch the first page
              //
              console.log(pdf)
              // these are  happening concurrently
                
              //console.log(i);
                //convertPage(pdf.getPage(i));
              percent_increment = 100 / pdf.numPages;
              var page_promise = 1;
              var prom_list = [];
              var prom_chain;

              //prom_list.push(new Promise((resolve, reject) => {resolve(loadPage(pdf, 1))})); 

              for(var i = 1; i <= pdf.numPages; i++) {
                console.log("start");

                page_promise = loadPage(pdf,i,page_promise);
                prom_list.push(new Promise((resolve, reject) => {resolve(page_promise)})); 
                
              }
              Promise.all(prom_list).then(function() {
                console.log("downloading");
                o_pdf.save(save_name);
                o_pdf = new jsPDF();
                document.getElementById("process_status").style.color = "black";
                document.getElementById('process_status').innerHTML = "Done."
                percent_obj.innerHTML = "";

              })

            });
          };
          fileReader.readAsArrayBuffer(file);

        }
        else {
          document.getElementById('process_status').innerHTML = "Error: invalid file.";
        }
      }

    };

    pdf.onchange = function(ev) {
      if(['application/pdf'].indexOf(pdf.files[0].type) == -1) {
        pdfError();
        return;
      }
      else {
        document.getElementById('process_status').innerHTML = "";
      }
    };



    async function loadPage(pdf, i, prom) {

      await prom;
      if(i > 1) {
        o_pdf.addPage();
      }
      return pdf.getPage(i).then(function(page) {
          return (new Promise((resolve, reject) => {resolve(convertPage(page, i))}));
        });
      
      
    }

    function convertPage(page, i) {
      var scale = 1.3;
      //var viewport = page.getViewport(canvas.width / page.getViewport(1.0).width);
      var viewport = page.getViewport(scale);
      //
      // Prepare canvas using PDF page dimensions
      //

      var canvas = document.createElement('canvas');
      var context = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      
      //var c = new Croppie(document.getElementById('item'), opts);

      //
      // Render PDF page into canvas context
      // try to do for specific page???
      var task = page.render({canvasContext: context, viewport: viewport})
      return task.promise.then(function(){
        
        var imgData = canvas.toDataURL("image/jpeg", 1.0);

        var imgCrop = new Image();
        imgCrop.src = getImagePortion(canvas, canvas.width, canvas.height, 0, (canvas.height * (inches/11)), 1);
        o_pdf.setPage(i);
        o_pdf.addImage(imgCrop, 'JPEG', 0, 0);
      
        console.log("page saved");
        console.log(percent_increment);
        updatePercent(percent_increment);

      });
    }

    function getImagePortion(imgObj, newWidth, newHeight, startX, startY, ratio) {
      var retCanvas = document.createElement('canvas');
      var retContext = retCanvas.getContext('2d');
      retCanvas.width = newWidth; retCanvas.height = newHeight;
      
      var bufferCanvas = document.createElement('canvas');
      var bufferContext = bufferCanvas.getContext('2d');
      bufferCanvas.width = imgObj.width;
      bufferCanvas.height = imgObj.height;
      bufferContext.drawImage(imgObj, 0, 0);

      retContext.drawImage(bufferCanvas, startX,startY,newWidth * ratio, newHeight * ratio,0,0,newWidth,newHeight);
      return retCanvas.toDataURL();
    }

    async function returnProm(prom1, prom2) {
      await prom1;

      return prom2;
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function pdfError() {
      document.getElementById("process_status").style.color = "red";
      document.getElementById('process_status').innerHTML = "Error: not a PDF.";
    }

    function numberError() {
      document.getElementById("process_status").style.color = "red";
      document.getElementById('process_status').innerHTML = "Error: invalid number.";
    }

    function lowerBoundError() {
      document.getElementById("process_status").style.color = "red";
      document.getElementById('process_status').innerHTML = "Error: number must be greater than or equal to 0.";
    }


    function upperBoundError() {
      document.getElementById("process_status").style.color = "red";
      document.getElementById('process_status').innerHTML = "Error: number must be less than or equal to 11.";
    }

    function fileError() {
      document.getElementById("process_status").style.color = "red";
      document.getElementById('process_status').innerHTML = "Error: no file.";
    }

    function noError() {
       document.getElementById('process_status').innerHTML = "";
    }

    function updatePercent(inc) {
      if(loading_percent < 100) {
        loading_percent += inc;
      }

      percent_obj.innerHTML = Math.round(loading_percent) + "%";
      console.log(percent_obj.innerHTML);

    }
  </script>
  

<style id="jsbin-css">
</style>
<script>
</script>
</body>
</html>