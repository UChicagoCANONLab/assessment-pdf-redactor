<script src="http://cdnjs.cloudflare.com/ajax/libs/processing.js/1.4.1/processing-api.min.js"></script><html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.4.1/jspdf.debug.js" integrity="sha384-THVO/sM0mFD9h7dfSndI6TS0PgAGavwKvB5hAxRRvc0o9cPLohB0wb/PTA7LdUHs" crossorigin="anonymous"></script>

<!--
  Created using jsbin.com
  Source can be edited via http://jsbin.com/pdfjs-helloworld-v2/8598/edit
-->
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <link href="jscropper.css" rel="stylesheet">
</head>
<body>
  <div style="text-align:center;">
    <h1> pdf cropper </h1>
    <input id='pdf' type='file' class="btn"/>

    <form>
      <div class='text_box'>
        <label for="uname">Inches to be cropped: </label>
        <input type="text" id="inches_input" name="name" placeholder="0 - 11; Default is 1">
      </div>
    </form>

    <input type="button" class="btn" value="Crop" id = "redact_button"/>

    <p class="status" id="process_status"></p>
    <p class="wait_time" id="wait_time"></p>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script type="text/javascript" src="pdf.js"></script>
  <script type="text/javascript"> 
    $(document).ready(function(){
      $(document).keypress(function(e){
        if (e.which == 13){
          $("#redact_button").click();
        }
      });
      $(function() {
        $("form").submit(function() { return false; });
      });
    });
  </script>
  <script type="text/javascript">

    //
    // Disable workers to avoid yet another cross-origin issue (workers need the URL of
    // the script to be loaded, and dynamically loading a cross-origin script does
    // not work)
    //
    PDFJS.disableWorker = true;
    //
    // Asynchronous download PDF as an ArrayBuffer
    //
    var pdf = document.getElementById('pdf');
    var percent_obj = document.getElementById('wait_time');
    var o_pdf = new jsPDF("p", "mm", "a4" );

    var INCHES = 1;
    var SAVE_NAME;
    var LOADING_PERCENT = 0;
    var PERCENT_INCREMENT = 0;
    var STAGED = false;

    document.getElementById('pdf').onclick = function() {
      document.getElementById('pdf').blur();
    }

    document.getElementById('redact_button').onclick = function() {
      document.getElementById('redact_button').blur();
      if(STAGED) {
        console.log("downloading");
        o_pdf.save(SAVE_NAME);
        o_pdf = new jsPDF();
        return;
      }
      
      LOADING_PERCENT = 0;

      INCHES = document.getElementById('inches_input').value;
      if(Number(INCHES)) {
        INCHES = Number(INCHES);
      }
      else if(INCHES == "" || !INCHES) {
        INCHES = 1;
      }
      else {
        INCHES = NaN;
      }

      if(!pdf.files[0]) {
        fileError();
        return;
      }
      if(['application/pdf'].indexOf(pdf.files[0].type) == -1) {
        pdfError();
        return;
      }
      if(!INCHES) {
        numberError();
        return;
      }
      if(INCHES < 0) {
        lowerBoundError();
        return;
      }
      if(INCHES > 11) {
        upperBoundError();
        return;
      }

      file = pdf.files[0] 
      document.getElementById("process_status").style.color = "black";
      document.getElementById('process_status').innerHTML = "Processing... For better performance, stay on this tab.";
      updatePercent(0);
      

      fileReader = new FileReader();

      fileReader.onload = function(ev) {
        SAVE_NAME = "CROPPED_" + pdf.files[0].name;

        console.log(ev);
        PDFJS.getDocument(fileReader.result).then(function getPdfHelloWorld(pdf) {
          
          console.log(pdf)
         
          PERCENT_INCREMENT = 100 / pdf.numPages;
          var page_promise = 1;
          var prom_list = [];
          var prom_chain;

          for(var i = 1; i <= pdf.numPages; i++) {
            console.log("start");
            page_promise = loadPage(pdf,i,page_promise);
            prom_list.push(new Promise((resolve, reject) => {resolve(page_promise)})); 
            
          }
          Promise.all(prom_list).then(function() {
          
            document.getElementById('redact_button').value = "Download";
            STAGED = true;
            document.getElementById("process_status").style.color = "black";
            document.getElementById('process_status').innerHTML = 'Done. Please refresh the page to crop another file.'
            percent_obj.innerHTML = "";

          })

        });
        };
        fileReader.readAsArrayBuffer(file);

    };

    pdf.onchange = function(ev) {
      if(['application/pdf'].indexOf(pdf.files[0].type) == -1) {
        pdfError();
        return;
      }
      else {
        document.getElementById('process_status').innerHTML = "";
      }
    };



    async function loadPage(pdf, i, prom) {

      await prom;
      if(i > 1) {
        o_pdf.addPage();
      }
      return pdf.getPage(i).then(function(page) {
          return (new Promise((resolve, reject) => {resolve(convertPage(page, i))}));
        });
      
      
    }

    function convertPage(page, i) {
      var scale = 2;
      //var viewport = page.getViewport(canvas.width / page.getViewport(1.0).width);
      var viewport = page.getViewport(scale);
      //
      // Prepare canvas using PDF page dimensions
      //

      var canvas = document.createElement('canvas');
      var context = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      
      //var c = new Croppie(document.getElementById('item'), opts);

      //
      // Render PDF page into canvas context
      // try to do for specific page???
      var task = page.render({canvasContext: context, viewport: viewport})
      return task.promise.then(function(){
        
        var imgData = canvas.toDataURL("image/jpeg", 1.0);

        var imgCrop = new Image();
        imgCrop.src = getImagePortion(canvas, canvas.width, canvas.height, 0, (canvas.height * (INCHES/11)), 1);
        o_pdf.setPage(i);
        o_pdf.addImage(imgCrop, 'JPEG', 0,0, 210, 297);
      
        console.log("page saved");
        console.log(PERCENT_INCREMENT);
        updatePercent(PERCENT_INCREMENT);

      });
    }

    function getImagePortion(imgObj, newWidth, newHeight, startX, startY, ratio) {
      var retCanvas = document.createElement('canvas');
      var retContext = retCanvas.getContext('2d');
      retCanvas.width = newWidth; retCanvas.height = newHeight;
      
      var bufferCanvas = document.createElement('canvas');
      var bufferContext = bufferCanvas.getContext('2d');
      bufferCanvas.width = imgObj.width;
      bufferCanvas.height = imgObj.height;
      bufferContext.drawImage(imgObj, 0, 0);

      retContext.drawImage(bufferCanvas, startX,startY,newWidth * ratio, newHeight * ratio,0,0,newWidth,newHeight);
      return retCanvas.toDataURL();
    }

    function pdfError() {
      document.getElementById("process_status").style.color = "red";
      document.getElementById('process_status').innerHTML = "Error: not a PDF.";
    }

    function numberError() {
      document.getElementById("process_status").style.color = "red";
      document.getElementById('process_status').innerHTML = "Error: invalid number.";
    }

    function lowerBoundError() {
      document.getElementById("process_status").style.color = "red";
      document.getElementById('process_status').innerHTML = "Error: number must be greater than or equal to 0.";
    }


    function upperBoundError() {
      document.getElementById("process_status").style.color = "red";
      document.getElementById('process_status').innerHTML = "Error: number must be less than or equal to 11.";
    }

    function fileError() {
      document.getElementById("process_status").style.color = "red";
      document.getElementById('process_status').innerHTML = "Error: no file.";
    }

    function noError() {
       document.getElementById('process_status').innerHTML = "";
    }

    function updatePercent(inc) {
      if(LOADING_PERCENT < 100) {
        LOADING_PERCENT += inc;
      }

      percent_obj.innerHTML = Math.round(LOADING_PERCENT) + "%";
      console.log(percent_obj.innerHTML);
    }
  </script>
  

<style id="jsbin-css">
</style>
<script>
</script>
</body>
</html>